console.log('main.js loaded');

var $main,
    $display,
    $categoryTemplate,
    $placeTemplate,
    $displayTemplate,
    $favoritesTemplate,
    $notesTemplate,
    $noteDisplayTemplate,
    $noteEditTemplate,
    $favorites,
    $favoritesList,
    $removeFromFavorite,
    renderCategory,
    renderPlace,
    renderDisplayDiv,
    renderFavorite,
    renderNotesForm,
    renderNote,
    renderEditNote,
    currentDestinationId;

addDisplayDiv = function(location) {
  return $(renderDisplayDiv({location: _.capitalize(location)})).appendTo($main);
}

addCategory = function($displayEl, name) {
  var $attachEl = $displayEl[4];
  return $(renderCategory({name: name, title: _.capitalize(name.replace('_', ' '))}))
   .appendTo($attachEl);
}

addPlace = function($categoryEl, gid, name, src, rating) {
  var $attachEl = $categoryEl.find('ul');
  $(renderPlace({gid: gid, name: name, src: src, rating: rating}))
   .appendTo($attachEl);
}

addFavorite = function(id, location) {
  $(renderFavorite({id: id, location: location})).appendTo($favoritesList);
  addNoteForm(id);

  $('.remove').click(function(){
    var $id = $(this).parent().attr('data-destination-id');
    var $li = $(this).parent();

    // warning to ensure that the user meant to delete
    deleteFromFavorites($id, $li)

  })
}

addNoteForm = function(id) {
  $(renderNotesForm({id: id})).appendTo($main);
  $('#save-note').click(function(e){
    e.preventDefault();
    var $destination_id = $('#destination-id-input').val();
    var $noteTitle = $('#note-title').val();
    var $noteBody = $('#note-body').val();
    $.ajax({
      url:      '/notes',
      type:     'post',
      dataType: 'json',
      data:     {note: {title: $noteTitle, body: $noteBody, destination_id: $destination_id}}
    }).done(function(data){
      console.log(data);
      addNote([data]);
    });
  });
}

addNote = function(data){
  for (var i=0,len=data.length; i<len; i++){
    var title  = data[i].title,
        date   = data[i].created_at,
        body   = data[i].body,
        noteId = data[i].id;
    $(renderNote({title: title, date: date, body: body, note_id: noteId})).appendTo($('.note-part'));
  }
  // add event listener on buttons to edit and delete
  $('.edit-note-button').click(function(){
    var $noteId = $(this).parent().attr('data-note-id'),
        $title  = $(this).parent().children().first().text(),
        $body   = $(this).parent().children('p').text();

    editNote($noteId, $title, $body);
  })
}

editNote = function($noteId, $title, $body){
  var $currentNote = $('[data-note-id="' + $noteId + '"]');
  $currentNote.children().hide();
  $(renderEditNote({title: $title, body: $body})).appendTo($currentNote);
    // update event listener
    $('#update-note').click(function(e){
      e.preventDefault();
      var $newTitle = $('#edit-title').val(),
          $newBody  = $('#edit-body').val();
      $.ajax({
        url:      '/destinations/' + currentDestinationId + '/notes/' + $noteId,
        type:     'put',
        dataType: 'json',
        data:     {note: {title: $newTitle, body: $newBody}}
      }).done(function(data){
        $currentNote.children().first().text(data.title);
        $currentNote.children('p').text(data.body);
        $currentNote.children().show();
        $('#note-edit-form').remove();
        // debugger
      })

    })
}

createPhotoUrl = function(photo_reference) {
  return 'https://maps.googleapis.com/maps/api/place/photo?maxwidth=100&photoreference=' + photo_reference + '&key=<%= ENV["GOOGLE_BROWSER_API_KEY"] %>'
}

requestInfoAboutPlace = function(searchLocation) {
      $.ajax({
      url:      '/destinations',
      dataType: 'json',
      type:     'get',
      data:     {location: searchLocation}
    }).success(function(data){
      // console.log(data);
      var $category, $displayEl;

      $displayEl = addDisplayDiv(searchLocation);

      for (var category in data) {
        $category  = addCategory($displayEl, category);
        // console.log($category);

        var name, photos;
        for (var i=0,len=data[category].length;i<len;i++) {
          // console.log(i); console.log(len);
          gid    = data[category][i].id
          name   = data[category][i].name
          photos = data[category][i].photos
          rating = data[category][i].rating

          photos = _.map(photos, function(photo) {
            return photo.photo_reference;
          });

          addPlace($category, gid, name, createPhotoUrl(photos[0]), rating);
        }
      }
      $('#add-location-button').click(function(){
        var location = $(this).attr('class');
        $.ajax({
          url:      '/destinations',
          type:     'post',
          dataType: 'json',
          data:     {destination: {location: location}}
        }).success(function(data){
          console.log(data)
          // debugger
          var newest_location = data[data.length - 1];
          var id              = newest_location.id;
          var location        = newest_location.location;
          addFavorite(id, location);

        })
      })

    }).error(function(error){
      sweetAlert("Oops...", "Something went wrong!", "error");
      console.log("Status Code: "+error.status);
      console.log("Status Text: "+error.statusText);
    })
}

var deleteFromFavorites = function($id, $li){
  swal({
  title: "Are you sure you want to delete this destination?",
  text: "You will not be able to recover the data you have saved to it!",
  type: "warning",
  showCancelButton: true,
  confirmButtonColor: "#DD6B55",
  confirmButtonText: "Yes, delete it!",
  cancelButtonText: "No, cancel!",
  closeOnConfirm: false,
  closeOnCancel: false },
  function(isConfirm){
    if (isConfirm) {
      $.ajax({
        url:      '/destinations/' + $id,
        type:     'delete',
        dataType: 'json',
      }).done(function(){
        $li.remove();
        swal("Deleted!", "Your destination has been deleted.", "success");
      })
    } else {
      swal("Cancelled", "Your favorited destination is safe :)", "error");
    }
  });
}

$(document).ready(function(){
  $main                = $('.main');
  $display             = $('.display');
  $categoryTemplate    = $('#gplaces-category');
  $placeTemplate       = $('#gplaces-place');
  $displayTemplate     = $('#outline');
  $favoritesTemplate   = $('#favorites-template');
  $notesTemplate       = $('#notes-form-template');
  $noteDisplayTemplate = $('#note-display-template');
  $noteEditTemplate    = $('#edit-note-template');
  $favorites           = $('.favorites');
  $favoritesList       = $('.favorites-list');
  $removeFromFavorite  = $('.remove');
  renderCategory       = _.template($categoryTemplate.html());
  renderPlace          = _.template($placeTemplate.html());
  renderDisplayDiv     = _.template($displayTemplate.html());
  renderFavorite       = _.template($favoritesTemplate.html());
  renderNotesForm      = _.template($notesTemplate.html());
  renderNote           = _.template($noteDisplayTemplate.html());
  renderEditNote       = _.template($noteEditTemplate.html());



  // when a user hits enter or the button to search for a location, these events are triggered:
  //   the google place api gets hit and information gets appended to the page
  $('.location-search').on('submit', function(event){
    event.preventDefault();
    $('.note-part').children().remove();
    $main.children().remove();

    var searchLocation = $('.location-input').val();
    // contact the database to use ruby gem to find latitude and longitude of the loacation
    requestInfoAboutPlace(searchLocation);

  })

  // a user can add a location to his favorites
  $favorites.click(function(){
    var $id            = $(this).parent().attr('data-destination-id');
    var searchLocation = $(this).text();
    $main.children().remove();
    // retrieve notes and additional information about the saved location
    $.ajax({
      url:      '/destinations/' + $id + '/notes',
      dataType: 'json',
      type:     'get'
    }).done(function(data){
      currentDestinationId = $id;
      addNoteForm($id);
      addNote(data);
      requestInfoAboutPlace(searchLocation);
    });

  })

  $removeFromFavorite.click(function(){
    var $id = $(this).parent().attr('data-destination-id');
    var $li = $(this).parent();

    // warning to ensure that the user meant to delete
    deleteFromFavorites($id, $li)

  })


})
