console.log('main.js loaded');

var $main,
    $categoryTemplate,
    $placeTemplate,
    $displayTemplate,
    renderCategory,
    renderPlace,
    addCategory,
    addPlace,
    createPhotoUrl,
    saveLocationButton;

addDisplayDiv = function(location) {
  return $(renderDisplayDiv({location: _.capitalize(location)})).appendTo($main);
}

addCategory = function($displayEl, name) {
  var $attachEl = $displayEl[4];
  return $(renderCategory({name: name, title: _.capitalize(name.replace('_', ' '))}))
   .appendTo($attachEl);
}

addPlace = function($categoryEl, gid, name, src, rating) {
  var $attachEl = $categoryEl.find('ul');
  $(renderPlace({gid: gid, name: name, src: src, rating: rating}))
   .appendTo($attachEl);
}

createPhotoUrl = function(photo_reference) {
  return 'https://maps.googleapis.com/maps/api/place/photo?maxwidth=100&photoreference=' + photo_reference + '&key=<%= ENV["GOOGLE_BROWSER_API_KEY"] %>'
}

$(document).ready(function(){
  $main               = $('.main');
  $display            = $('.display');
  $categoryTemplate   = $('#gplaces-category');
  $placeTemplate      = $('#gplaces-place');
  $displayTemplate    = $('#outline');
  renderCategory      = _.template($categoryTemplate.html());
  renderPlace         = _.template($placeTemplate.html());
  renderDisplayDiv    = _.template($displayTemplate.html());




  $('.location-search').on('submit', function(event){
    event.preventDefault();
    $main.children().remove();

    var searchLocation = $('.location-input').val();
    // contact the database to use ruby gem to find latitude and longitude of the loacation
    $.ajax({
      url:      '/destinations',
      dataType: 'json',
      type:     'get',
      data:     {location: searchLocation}
    }).success(function(data){
      // console.log(data);
      var $category, $displayEl;

      $displayEl = addDisplayDiv(searchLocation);

      for (var category in data) {
        $category  = addCategory($displayEl, category);
        // console.log($category);

        var name, photos;
        for (var i=0,len=data[category].length;i<len;i++) {
          // console.log(i); console.log(len);
          gid    = data[category][i].id
          name   = data[category][i].name
          photos = data[category][i].photos
          rating = data[category][i].rating

          photos = _.map(photos, function(photo) {
            return photo.photo_reference;
          });

          addPlace($category, gid, name, createPhotoUrl(photos[0]), rating);
        }
      }
      $('#add-location-button').click(function(){
        var location = $(this).attr('class');
        $.ajax({
          url:      '/destinations',
          type:     'post',
          dataType: 'json',
          data:     {destination: {location: location}}
        }).done(function(data){
          console.log(data)
          // debugger
        })
      })

    }).error(function(error){
      sweetAlert("Oops...", "Something went wrong!", "error");
      console.log("Status Code: "+error.status);
      console.log("Status Text: "+error.statusText);
    })
  })


})
