console.log('main.js loaded');

var $main,
    $display,
    $categoryTemplate,
    $placeTemplate,
    $displayTemplate,
    $favoritesTemplate,
    $notesTemplate,
    $favorites,
    $favoritesList,
    $removeFromFavorite,
    renderCategory,
    renderPlace,
    renderDisplayDiv,
    renderFavorite,
    renderNotesForm;

addDisplayDiv = function(location) {
  return $(renderDisplayDiv({location: _.capitalize(location)})).appendTo($main);
}

addCategory = function($displayEl, name) {
  var $attachEl = $displayEl[4];
  return $(renderCategory({name: name, title: _.capitalize(name.replace('_', ' '))}))
   .appendTo($attachEl);
}

addPlace = function($categoryEl, gid, name, src, rating) {
  var $attachEl = $categoryEl.find('ul');
  $(renderPlace({gid: gid, name: name, src: src, rating: rating}))
   .appendTo($attachEl);
}

addFavorite = function(id, location) {
  $(renderFavorite({id: id, location: location})).appendTo($favoritesList);
  addNoteForm(id);

  $('.remove').click(function(){
    var $id = $(this).parent().attr('data-id');
    var $li = $(this).parent();

    // warning to ensure that the user meant to delete
    deleteFromFavorites($id, $li)

  })
}

addNoteForm = function(id) {
  $(renderNotesForm({id: id})).appendTo($main);
  $('#save-note').click(function(e){
    e.preventDefault();
    var $destination_id = $('#destination-id-input').val();
    var $noteTitle = $('#note-title').val();
    var $noteBody = $('#note-body').val();
    $.ajax({
      url:      '/notes',
      type:     'post',
      dataType: 'json',
      data:     {note: {title: $noteTitle, body: $noteBody, destination_id: $destination_id}}
    }).done(function(data){
      console.log(data);
      debugger
    })
  })
}

createPhotoUrl = function(photo_reference) {
  return 'https://maps.googleapis.com/maps/api/place/photo?maxwidth=100&photoreference=' + photo_reference + '&key=<%= ENV["GOOGLE_BROWSER_API_KEY"] %>'
}

requestInfoAboutPlace = function(searchLocation) {
      $.ajax({
      url:      '/destinations',
      dataType: 'json',
      type:     'get',
      data:     {location: searchLocation}
    }).success(function(data){
      // console.log(data);
      var $category, $displayEl;

      $displayEl = addDisplayDiv(searchLocation);

      for (var category in data) {
        $category  = addCategory($displayEl, category);
        // console.log($category);

        var name, photos;
        for (var i=0,len=data[category].length;i<len;i++) {
          // console.log(i); console.log(len);
          gid    = data[category][i].id
          name   = data[category][i].name
          photos = data[category][i].photos
          rating = data[category][i].rating

          photos = _.map(photos, function(photo) {
            return photo.photo_reference;
          });

          addPlace($category, gid, name, createPhotoUrl(photos[0]), rating);
        }
      }
      $('#add-location-button').click(function(){
        var location = $(this).attr('class');
        $.ajax({
          url:      '/destinations',
          type:     'post',
          dataType: 'json',
          data:     {destination: {location: location}}
        }).success(function(data){
          console.log(data)
          // debugger
          var newest_location = data[data.length - 1];
          var id              = newest_location.id;
          var location        = newest_location.location;
          addFavorite(id, location);

        })
      })

    }).error(function(error){
      sweetAlert("Oops...", "Something went wrong!", "error");
      console.log("Status Code: "+error.status);
      console.log("Status Text: "+error.statusText);
    })
}

var deleteFromFavorites = function($id, $li){
  swal({
  title: "Are you sure you want to delete this destination?",
  text: "You will not be able to recover the data you have saved to it!",
  type: "warning",
  showCancelButton: true,
  confirmButtonColor: "#DD6B55",
  confirmButtonText: "Yes, delete it!",
  cancelButtonText: "No, cancel!",
  closeOnConfirm: false,
  closeOnCancel: false },
  function(isConfirm){
    if (isConfirm) {
      $.ajax({
        url:      '/destinations/' + $id,
        type:     'delete',
        dataType: 'json',
      }).done(function(){
        $li.remove();
        swal("Deleted!", "Your destination has been deleted.", "success");
      })
    } else {
      swal("Cancelled", "Your favorited destination is safe :)", "error");
    }
  });
}

$(document).ready(function(){
  $main               = $('.main');
  $display            = $('.display');
  $categoryTemplate   = $('#gplaces-category');
  $placeTemplate      = $('#gplaces-place');
  $displayTemplate    = $('#outline');
  $favoritesTemplate  = $('#favorites-template');
  $notesTemplate      = $('#notes-form-template');
  $favorites          = $('.favorites');
  $favoritesList      = $('.favorites-list');
  $removeFromFavorite = $('.remove');
  renderCategory      = _.template($categoryTemplate.html());
  renderPlace         = _.template($placeTemplate.html());
  renderDisplayDiv    = _.template($displayTemplate.html());
  renderFavorite      = _.template($favoritesTemplate.html());
  renderNotesForm     = _.template($notesTemplate.html());




  $('.location-search').on('submit', function(event){
    event.preventDefault();
    $main.children().remove();

    var searchLocation = $('.location-input').val();
    // contact the database to use ruby gem to find latitude and longitude of the loacation

    requestInfoAboutPlace(searchLocation);

  })

  $favorites.click(function(){
    var $id            = $(this).parent().attr('data-id');
    var searchLocation = $(this).text();
    $main.children().remove();
    addNoteForm($id);
    requestInfoAboutPlace(searchLocation);

  })

  $removeFromFavorite.click(function(){
    var $id = $(this).parent().attr('data-id');
    var $li = $(this).parent();

    // warning to ensure that the user meant to delete
    deleteFromFavorites($id, $li)

  })


})
